# AGENTS.md

## Project Overview
Telegram –±–æ—Ç –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏ —Ä–∞—Ü–∏–æ–Ω–æ–≤ –ø–∏—Ç–∞–Ω–∏—è —Å –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–æ–º –∫–∞–ª–æ—Ä–∏–π.

**Tech Stack:**
- Python 3.10+
- aiogram 3.22 (Telegram Bot API)
- aiosqlite (async SQLite)
- APScheduler 4.x (—Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏)

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:**
- `bot.py` ‚Äî —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞ –∏ scheduler
- `database.py` ‚Äî –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ë–î, –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
- `handlers/` ‚Äî —Ä–æ—É—Ç–µ—Ä—ã aiogram (user, admin, calculator)
- `keyboards/` ‚Äî –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –∏ callback-–¥–∞–Ω–Ω—ã–µ
- `data/` ‚Äî —Ä–µ—Ü–µ–ø—Ç—ã –∏ –∫–æ–Ω—Ç–µ–Ω—Ç (RECIPES + FMD_RECIPES)
- `followup.py` ‚Äî —Å–∏—Å—Ç–µ–º–∞ follow-up —Å–æ–æ–±—â–µ–Ω–∏–π

**–ü—Ä–æ–¥—É–∫—Ç—ã:**
- üçΩ **–†–∞—Ü–∏–æ–Ω—ã –ø–∏—Ç–∞–Ω–∏—è** (14 –¥–Ω–µ–π) ‚Äî 3000 ‚ÇΩ
  - –ö–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å: 1200-2100 –∫–∫–∞–ª
  - –ó–∞–≤—Ç—Ä–∞–∫ + –æ–±–µ–¥ + —É–∂–∏–Ω –µ–∂–µ–¥–Ω–µ–≤–Ω–æ
- ü•ó **FMD –ü—Ä–æ—Ç–æ–∫–æ–ª** (5 –¥–Ω–µ–π) ‚Äî 990 ‚ÇΩ
  - –î–∏–µ—Ç–∞ –∏–º–∏—Ç–∏—Ä—É—é—â–∞—è –≥–æ–ª–æ–¥–∞–Ω–∏–µ
  - –û—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç —Å –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–º –¥–æ—Å—Ç—É–ø–æ–º

## Dev Environment Tips

```bash
# –°–æ–∑–¥–∞—Ç—å venv
python -m venv venv
venv\Scripts\activate  # Windows

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
pip install -r requirements.txt

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)
BOT_TOKEN=your_bot_token
ADMIN_CHANNEL_ID=-100123456789
PAYMENT_AMOUNT=3000  # –†–∞—Ü–∏–æ–Ω—ã –ø–∏—Ç–∞–Ω–∏—è (14 –¥–Ω–µ–π)
FMD_PAYMENT_AMOUNT=990  # FMD –ü—Ä–æ—Ç–æ–∫–æ–ª (5 –¥–Ω–µ–π)
PAYMENT_DETAILS="–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã: 1234..."
```

## Build & Run Commands

```bash
# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
python bot.py

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞—ë—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ (bot_database.db)
```

## Code Style Guidelines

- **–ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ:** snake_case –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π/–ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö, PascalCase –¥–ª—è –∫–ª–∞—Å—Å–æ–≤
- **Async:** –í—Å–µ DB –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ API –≤—ã–∑–æ–≤—ã ‚Äî async/await
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `logger` –∏–∑ logging –º–æ–¥—É–ª—è
- **HTML ParseMode:** –î–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π Telegram
- **FSM:** aiogram FSM –¥–ª—è –º–Ω–æ–≥–æ—ç—Ç–∞–ø–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤
- **–ü—Ä–æ–¥—É–∫—Ç—ã:** –û—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–¥—É–∫—Ç–∞ (main/fmd)
- **–ë–î:** `product_type` –≤ –ø–ª–∞—Ç–µ–∂–∞—Ö –¥–ª—è —Ä–∞–∑–ª–∏—á–µ–Ω–∏—è –ø—Ä–æ–¥—É–∫—Ç–æ–≤

## Key Files Reference

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|-----------|
| `database.py` | EventType –∫–ª–∞—Å—Å, log_event(), get_stats() + FMD —Ñ—É–Ω–∫—Ü–∏–∏ |
| `handlers/admin.py` | –ê–¥–º–∏–Ω–∫–∞, —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –æ–ø–ª–∞—Ç (–æ—Å–Ω–æ–≤–Ω–æ–π + FMD) |
| `handlers/user.py` | /start, –æ–ø–ª–∞—Ç–∞, –≤—ã–±–æ—Ä —Ä–∞—Ü–∏–æ–Ω–æ–≤ + FMD –ø—Ä–æ—Ç–æ–∫–æ–ª |
| `handlers/calculator.py` | –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∫–∞–ª–æ—Ä–∏–π |
| `followup.py` | Follow-up —Å–æ–æ–±—â–µ–Ω–∏—è, —à–∞–±–ª–æ–Ω—ã |
| `config.py` | ADMIN_USERNAMES, —Ç–æ–∫–µ–Ω—ã, —Ü–µ–Ω—ã (PAYMENT_AMOUNT + FMD_PAYMENT_AMOUNT) |
| `data/recipes.py` | RECIPES (14 –¥–Ω–µ–π) + FMD_RECIPES (5 –¥–Ω–µ–π) |

## Analytics Events

```python
from database import EventType

EventType.START_COMMAND      # /start
EventType.PAYMENT_BUTTON_CLICKED  # –ù–∞–∂–∞–ª "–Ø –æ–ø–ª–∞—Ç–∏–ª(–∞)"
EventType.SCREENSHOT_SENT    # –ü—Ä–∏—Å–ª–∞–ª —Å–∫—Ä–∏–Ω
EventType.PAYMENT_APPROVED   # –û–ø–ª–∞—Ç–∞ –æ–¥–æ–±—Ä–µ–Ω–∞
EventType.PAYMENT_REJECTED   # –û–ø–ª–∞—Ç–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞
```

## FMD Protocol (Fast Mimicking Diet)

- **–ü—Ä–æ–¥—É–∫—Ç:** –î–∏–µ—Ç–∞ –∏–º–∏—Ç–∏—Ä—É—é—â–∞—è –≥–æ–ª–æ–¥–∞–Ω–∏–µ (5 –¥–Ω–µ–π)
- **–¶–µ–Ω–∞:** 990 ‚ÇΩ (–æ—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ–¥—É–∫—Ç)
- **–§—É–Ω–∫—Ü–∏–∏:**
  - –ü–æ–ª–Ω–∞—è 5-–¥–Ω–µ–≤–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø–∏—Ç–∞–Ω–∏—è
  - –°–ø–∏—Å–æ–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –Ω–∞ –Ω–µ–¥–µ–ª—é
  - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ç–æ–∫–æ–ª–µ FMD
  - –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–π –¥–æ—Å—Ç—É–ø –æ—Ç –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ä–∞—Ü–∏–æ–Ω–æ–≤
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:** `has_paid_fmd` –ø–æ–ª–µ, `product_type='fmd'` –≤ –ø–ª–∞—Ç–µ–∂–∞—Ö

## Follow-up System

- Scheduler –∑–∞–ø—É—Å–∫–∞–µ—Ç –∑–∞–¥–∞—á–∏ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω / 1 —á–∞—Å
- `only_start` ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –Ω–∞–∂–∞–≤—à–∏–µ —Ç–æ–ª—å–∫–æ /start (24—á+)
- `clicked_payment` ‚Äî –Ω–∞–∂–∞–ª–∏ –æ–ø–ª–∞—Ç—É, –Ω–æ –±–µ–∑ —Å–∫—Ä–∏–Ω–∞ (2—á+)
- Follow-up –æ—Ç–º–µ–Ω—è—é—Ç—Å—è –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã (`cancel_user_followups`)

## Payment Flow

- **–û—Å–Ω–æ–≤–Ω–æ–π —Ä–∞—Ü–∏–æ–Ω:** PAYMENT_AMOUNT (3000‚ÇΩ) ‚Üí `has_paid=1`
- **FMD –ø—Ä–æ—Ç–æ–∫–æ–ª:** FMD_PAYMENT_AMOUNT (990‚ÇΩ) ‚Üí `has_paid_fmd=1`
- –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ –ø–ª–∞—Ç–µ–∂–∞–º–∏
- –û–¥–∏–Ω–∞–∫–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–∫–∞–Ω–∞–ª

## Broadcast System (–†–∞—Å—Å—ã–ª–∫–∏)

–ê–¥–º–∏–Ω—ã –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å —Ä–∞—Å—Å—ã–ª–∫–∞–º–∏ —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å:

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- üì£ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–æ–∫ —Å –ø—Ä–µ–≤—å—é —Ç–µ–∫—Å—Ç–∞
- üéØ –í—ã–±–æ—Ä –∞—É–¥–∏—Ç–æ—Ä–∏–∏:
  - –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
  - –¢–æ–ª—å–∫–æ /start (–Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–ª–∏)
  - –û—Ç–∫–ª–æ–Ω—ë–Ω–Ω—ã–µ –æ–ø–ª–∞—Ç—ã
  - –ù–∞–∂–∞–ª–∏ –æ–ø–ª–∞—Ç—É –±–µ–∑ —Å–∫—Ä–∏–Ω–∞
- ‚è∞ –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –¥–∞—Ç–µ/–≤—Ä–µ–º–µ–Ω–∏ (–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥, GMT+5)
- üìã –°–ø–∏—Å–æ–∫ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –æ—Ç–º–µ–Ω—ã

**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:** —Ç–∞–±–ª–∏—Ü–∞ `broadcasts` —Å –ø–æ–ª—è–º–∏:
- `content`, `audience`, `scheduled_at`, `status`
- `created_by`, `sent_count`, `failed_count`

**Scheduler:** –∑–∞–¥–∞—á–∞ `process_broadcasts` –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É –ø—Ä–æ–≤–µ—Ä—è–µ—Ç pending —Ä–∞—Å—Å—ã–ª–∫–∏

## Template System (–®–∞–±–ª–æ–Ω—ã)

–ê–¥–º–∏–Ω—ã –º–æ–≥—É—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ç–µ–∫—Å—Ç—ã —Ä–∞—Å—Å—ã–ª–æ–∫ –∫–∞–∫ —à–∞–±–ª–æ–Ω—ã –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

**–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- üìÅ –°–æ–∑–¥–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º
- üìã –°–ø–∏—Å–æ–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤
- üì® –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ –¥–ª—è –æ–±—ã—á–Ω–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏
- ü§ñ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ –¥–ª—è –∞–≤—Ç–æ-—Ä–∞—Å—Å—ã–ª–∫–∏
- üóë –£–¥–∞–ª–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤

**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:** —Ç–∞–±–ª–∏—Ü–∞ `broadcast_templates` —Å –ø–æ–ª—è–º–∏:
- `name`, `content`, `created_by`, `created_by_username`

## Auto-Broadcast System (–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏)

–¢—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ —Å–æ–±—ã—Ç–∏—è–º:

**–¢—Ä–∏–≥–≥–µ—Ä—ã:**
- üëÜ `only_start`: —Ç–æ–ª—å–∫–æ –Ω–∞–∂–∞–ª–∏ /start (–Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–ª–∏)
- üí≥ `no_payment`: –Ω–∞–∂–∞–ª–∏ –æ–ø–ª–∞—Ç–∏—Ç—å, –Ω–æ –Ω–µ –æ–ø–ª–∞—Ç–∏–ª–∏
- ‚ùå `rejected`: –æ—Ç–∫–ª–æ–Ω—ë–Ω–Ω–∞—è –æ–ø–ª–∞—Ç–∞
- ü§î `no_screenshot`: –Ω–∞–∂–∞–ª–∏ –æ–ø–ª–∞—Ç–∏—Ç—å –±–µ–∑ —Å–∫—Ä–∏–Ω–∞

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏:**
- ‚è∞ –ó–∞–¥–µ—Ä–∂–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: 1—á, 2—á, 6—á, 12—á, 24—á, 48—á, 72—á
- üîÑ –í–∫–ª—é—á–µ–Ω–∏–µ/–≤—ã–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ-—Ä–∞—Å—Å—ã–ª–∫–∏
- üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–æ–∫

**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:**
- `auto_broadcasts`: –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ-—Ä–∞—Å—Å—ã–ª–æ–∫
- `auto_broadcast_sent`: –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö (—á—Ç–æ–±—ã –Ω–µ —Å–ª–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ)

**Scheduler:** –∑–∞–¥–∞—á–∞ `process_auto_broadcasts` –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç—Ä–∏–≥–≥–µ—Ä—ã

